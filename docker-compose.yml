# Gittensor Validator Docker Compose Configuration
#
# Usage:
#   1. Copy env.example to .env and configure
#   2. Run: docker-compose up -d
#   3. Watchtower will auto-update when new images are pushed
#
# See docs/DOCKER.md for full documentation

services:
  validator:
    image: ${DOCKER_IMAGE:-entrius/gittensor-validator}:${DOCKER_TAG:-latest}
    container_name: gittensor-validator
    restart: unless-stopped

    # Environment from .env file
    env_file:
      - .env

    # Expose validator axon port
    ports:
      - "${PORT:-8099}:${PORT:-8099}"

    # Mount wallet directory (read-only for security)
    volumes:
      - ${WALLET_PATH:-~/.bittensor/wallets}:/home/validator/.bittensor/wallets:ro

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

    # Enable Watchtower auto-updates
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import gittensor; print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Watchtower - Automatic container updates
  # Polls Docker Hub every 5 minutes for new images
  watchtower:
    image: containrrr/watchtower:latest
    container_name: gittensor-watchtower
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      # Poll every 5 minutes (300 seconds)
      WATCHTOWER_POLL_INTERVAL: 300
      # Only update containers with the watchtower label
      WATCHTOWER_LABEL_ENABLE: "true"
      # Remove old images after updating
      WATCHTOWER_CLEANUP: "true"
      # Use rolling restarts for zero-downtime updates
      WATCHTOWER_ROLLING_RESTART: "true"
      # Log level
      WATCHTOWER_LOG_LEVEL: info
      # Include stopped containers
      WATCHTOWER_INCLUDE_STOPPED: "false"
      # Lifecycle hooks - log before/after updates
      WATCHTOWER_LIFECYCLE_HOOKS: "true"

    # Resource limits for watchtower
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

# Network configuration
# If you have existing Postgres containers, create an external network:
#   docker network create gittensor-network
# Then uncomment the following:
#
# networks:
#   default:
#     external: true
#     name: gittensor-network
